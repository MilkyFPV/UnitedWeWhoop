<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapQuest Pro - Distribution Package</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background: #3498db; }
        .btn-success { background: #2ecc71; }
        .btn-secondary { background: #95a5a6; }
        .btn-danger { background: #e74c3c; }

        .draw-mode-active {
            background: #e67e22 !important;
            box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
        }

        #map {
            height: calc(100vh - 120px);
            width: 100%;
        }

        .point-counter {
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
        }

        .shapes-management {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            padding: 20px;
        }

        .shape-item, .overlay-item {
            border: 2px solid #ecf0f1;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .shape-item.active, .overlay-item.active {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .shape-item:hover, .overlay-item:hover {
            border-color: #bdc3c7;
        }

        .shape-header, .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .shape-name-input, .overlay-name-input {
            font-weight: bold;
            border: 1px solid #ddd;
            padding: 4px 8px;
            background: #f9f9f9;
            border-radius: 4px;
            flex: 1;
            margin-right: 10px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 2000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .coord-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
        }

        .tab-button {
            flex: 1;
            padding: 8px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .tab-button.active {
            background: #3498db;
            color: white;
        }

        .mission-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 250px;
            display: none;
            z-index: 1000;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Leaflet marker customization */
        .draw-marker {
            background: transparent;
            border: none;
        }

        .current-marker {
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .marker-wrapper {
            background: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 11px;
        }

        .point-delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        input[type="file"] {
            display: none;
        }

        .overlay-status.visible {
            background: #2ecc71;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .overlay-status.hidden {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .shape-score {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .controls {
                padding: 5px;
                gap: 4px;
            }

            .btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .shapes-management {
                width: 95%;
                max-height: 90vh;
            }

            .modal-content {
                width: 95%;
            }

            .point-counter {
                font-size: 10px;
                padding: 3px 6px;
            }
        }

        /* Animation for measurement labels */
        .measurement-label, .measurement-label-closing, .area-label {
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="controls">
        <input type="file" id="fileInput" accept="image/*">
        <input type="file" id="fileInputProject" accept=".json">
        
        <button id="addOverlay" class="btn btn-primary">üìÅ Import Overlay</button>
        <button id="manageOverlays" class="btn" style="background: #16a085; color: white;">üñºÔ∏è Manage Overlays</button>
        <button id="editOverlay" class="btn btn-secondary" disabled>‚úèÔ∏è Edit Overlay</button>
        
        <div style="display: flex; align-items: center; gap: 5px;">
            <label style="font-size: 12px;">Opacity:</label>
            <input type="range" id="opacitySlider" min="0" max="100" value="100" 
                   style="width: 80px;" disabled title="Overlay transparency">
            <span id="opacityValue" style="font-size: 11px; min-width: 30px;">100%</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 5px;">
            <label style="font-size: 12px;">Text Size:</label>
            <input type="range" id="textSizeSlider" min="8" max="20" value="11" 
                   style="width: 80px;" title="Measurement text size">
            <span id="textSizeValue" style="font-size: 11px; min-width: 30px;">11px</span>
        </div>
        
        <button id="drawMode" class="btn btn-primary">üéØ Draw Points</button>
        <button id="viewPoints" class="btn btn-success" disabled>üìã View Points</button>
        <button id="exportGoogle" class="btn btn-success" disabled>üó∫Ô∏è Export to Google</button>
        <button id="startMission" class="btn" style="background: #9b59b6; color: white;" disabled>üöÄ Start Mission</button>
        
        <button id="addCoordinates" class="btn" style="background: #e67e22; color: white;" disabled>üìç Add Coords</button>
        <button id="importBulkCoords" class="btn" style="background: #8e44ad; color: white;" disabled>üì• Import Coords</button>
        <button id="testImport" class="btn" style="background: #c0392b; color: white;">üß™ Test Import</button>
        <button id="closeShape" class="btn" style="background: #27ae60; color: white;" disabled>üîó Close Shape</button>
        <button id="saveCurrentShape" class="btn" style="background: #27ae60; color: white;" disabled>üíæ Save Shape</button>
        <button id="renameShape" class="btn" style="background: #f39c12; color: white;" disabled>‚úèÔ∏è Rename</button>
        <button id="newShape" class="btn" style="background: #8e44ad; color: white;" disabled>üÜï New Shape</button>
        <button id="manageShapes" class="btn" style="background: #d35400; color: white;">üìã Manage Shapes</button>
        <button id="saveProject" class="btn" style="background: #2980b9; color: white;">üíæ Save Project</button>
        <button id="loadProject" class="btn" style="background: #2980b9; color: white;">üìÇ Load Project</button>
        <button id="showAllShapes" class="btn" style="background: #16a085; color: white;">üëÅÔ∏è Show All</button>
        <button id="hideAllShapes" class="btn" style="background: #e67e22; color: white;">üôà Hide All</button>
        <button id="toggleMeasurements" class="btn" style="background: #9b59b6; color: white;">üìè Show Measurements</button>
        <button id="clearAll" class="btn btn-danger">üóëÔ∏è Clear All</button>
        
        <div class="point-counter">
            <span id="pointCount">Points: 0</span>
            <span id="currentShapeInfo" style="margin-left: 10px;">Shape: None</span>
            <span id="totalShapes" style="margin-left: 10px;">Total Shapes: 0</span>
            <span id="shapeDistance" style="margin-left: 10px;">Distance: 0 km</span>
        </div>
    </div>
    
    <div id="map"></div>

    <!-- Mission Control Panel -->
    <div id="missionPanel" class="mission-panel">
        <h4 style="margin: 0 0 10px 0;">üöÅ Mission Control</h4>
        <div id="missionInfo">Ready for mission...</div>
        <div class="progress-bar">
            <div id="missionProgressBar" class="progress-fill"></div>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button id="pauseMission" class="btn btn-secondary" disabled>‚è∏Ô∏è Pause</button>
            <button id="stopMission" class="btn btn-danger">üõë Stop</button>
            <button id="speedUp" class="btn btn-primary">‚ö° Speed</button>
        </div>
    </div>

    <!-- Coordinate Input Modal -->
    <div id="coordModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Add Coordinates</h3>
                <span class="modal-close" style="cursor: pointer; font-size: 24px;">&times;</span>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="mapQuest.switchCoordTab('single')">Single Point</button>
                <button class="tab-button" onclick="mapQuest.switchCoordTab('bulk')">Bulk Import</button>
            </div>

            <!-- Single Point Panel -->
            <div id="singlePointPanel">
                <label>Latitude:</label>
                <input type="number" id="latInput" class="coord-input" step="any" placeholder="51.505">
                <label>Longitude:</label>
                <input type="number" id="lngInput" class="coord-input" step="any" placeholder="-0.09">
                <label>Name (optional):</label>
                <input type="text" id="nameInput" class="coord-input" placeholder="Point name">
                <div style="text-align: center; margin-top: 15px;">
                    <button id="addCoordPoint" class="btn btn-success">üìç Add Point</button>
                    <button id="cancelCoord" class="btn btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- Bulk Import Panel -->
            <div id="bulkImportPanel" style="margin: 15px 0; display: none;">
                <h4>Import Multiple Points</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Paste coordinates in format: lat,lng/lat,lng/lat,lng<br>
                    Example: 51.501844,-0.140591/51.507790,-0.127911
                </p>
                <label>Shape Name:</label>
                <input type="text" id="shapeNameInput" class="coord-input" placeholder="Enter shape name" style="margin-bottom: 10px;">
                <textarea id="bulkCoordsInput" class="coord-input" rows="6" 
                          placeholder="51.501844,-0.140591/51.507790,-0.127911/51.511396,-0.124350/51.515411,-0.124831"></textarea>
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" id="clearExistingPoints"> Clear existing points first
                    </label>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button id="importBulkPoints" class="btn btn-success">üì• Import Points</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay Management Panel -->
    <div id="overlayPanel" class="shapes-management" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>üñºÔ∏è Overlay Management</h3>
            <div>
                <button id="refreshOverlays" class="btn" style="background: #3498db; color: white; padding: 2px 6px; font-size: 12px; margin-right: 5px;" title="Refresh overlay list">üîÑ</button>
                <button id="closeOverlays" class="btn btn-secondary" style="padding: 2px 6px; font-size: 12px;">‚úó</button>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
            <div><strong>Overlay Statistics:</strong></div>
            <div id="overlayStats" style="font-size: 12px; margin-top: 5px;">
                Total Overlays: 0 | Active: None
            </div>
        </div>
        
        <div id="overlaysList">
            <div style="text-align: center; color: #999; padding: 20px;">
                No overlays added yet.<br>
                Click "Import Overlay" to add your first overlay!
            </div>
        </div>
    </div>

    <!-- Shape Management Panel -->
    <div id="shapesPanel" class="shapes-management">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>üìã Shape Management</h3>
            <div>
                <button id="refreshShapes" class="btn" style="background: #3498db; color: white; padding: 2px 6px; font-size: 12px; margin-right: 5px;" title="Refresh shape list">üîÑ</button>
                <button id="closeShapes" class="btn btn-secondary" style="padding: 2px 6px; font-size: 12px;">‚úó</button>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
            <div id="projectStats"><strong>Project Statistics:</strong><br><small>No shapes created yet.</small></div>
        </div>
        
        <div style="margin-bottom: 15px; text-align: center;">
            <button id="exportScores" class="btn" style="background: #27ae60; color: white;">üìä Export Scores CSV</button>
        </div>
        
        <div id="shapesList">
            <div style="text-align: center; color: #999; padding: 20px;">
                No shapes created yet.<br>
                Start drawing to create your first shape!
            </div>
        </div>
    </div>

    <!-- Edit Controls -->
    <div id="editControls" style="display: none; position: fixed; top: 120px; right: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <h4>Edit Overlay</h4>
        <button id="saveEdit" class="btn btn-success">üíæ Save</button>
        <button id="cancelEdit" class="btn btn-danger">‚ùå Cancel</button>
    </div>

    <!-- Status Display -->
    <div id="status" style="position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; z-index: 1000;">
        Ready! Import an overlay image or start drawing points.
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        class MapQuestComplete {
            constructor() {
                // Initialize map
                this.map = L.map('map').setView([40.7128, -74.0060], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);
                
                // State variables
                this.overlays = []; // Array to store multiple overlays
                this.activeOverlayId = null;
                this.nextOverlayId = 1;
                this.cornerMarkers = [];
                this.originalBounds = null;
                this.editMode = false;
                this.drawMode = false;
                this.routePoints = [];
                this.routeLines = [];
                
                // Shape management
                this.shapes = [];
                this.currentShapeId = null;
                this.nextShapeId = 1;
                this.shapeColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                
                // Current shape variables
                this.shapeClosedLine = null;
                this.shapeArea = 0;
                this.isShapeClosed = false;
                
                // Mission control variables
                this.missionActive = false;
                
                // Measurements
                this.measurementsVisible = false;
                this.measurementLabels = [];
                this.measurementTextSize = 11;
                this.missionPaused = false;
                this.currentPointIndex = 0;
                this.missionMarker = null;
                this.missionSpeed = 2000;
                this.missionInterval = null;
                
                this.setupEventListeners();
                this.updateStatus('Ready! Import an overlay image or start drawing points.');
            }

            setupEventListeners() {
                // Import overlay
                document.getElementById('addOverlay').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.addOverlay(file);
                    }
                });

                // Edit overlay
                document.getElementById('editOverlay').addEventListener('click', () => {
                    this.startEditMode();
                });

                // Opacity slider
                document.getElementById('opacitySlider').addEventListener('input', (e) => {
                    this.updateOverlayOpacity(e.target.value);
                });

                // Text size slider
                document.getElementById('textSizeSlider').addEventListener('input', (e) => {
                    this.updateMeasurementTextSize(e.target.value);
                });

                // Draw mode
                document.getElementById('drawMode').addEventListener('click', () => {
                    this.toggleDrawMode();
                });

                // View points
                document.getElementById('viewPoints').addEventListener('click', () => {
                    this.showPointsPanel();
                });

                // Export to Google
                document.getElementById('exportGoogle').addEventListener('click', () => {
                    this.exportToGoogle();
                });

                // Start mission
                document.getElementById('startMission').addEventListener('click', () => {
                    this.startMission();
                });

                // Add coordinates
                document.getElementById('addCoordinates').addEventListener('click', () => {
                    this.showCoordinateModal();
                });

                // Import bulk coordinates
                document.getElementById('importBulkCoords').addEventListener('click', () => {
                    this.showCoordinateModal('bulk');
                });

                // Test import with your coordinates
                document.getElementById('testImport').addEventListener('click', () => {
                    this.testImportCoordinates();
                });

                // Close shape
                document.getElementById('closeShape').addEventListener('click', () => {
                    this.closeShape();
                });

                // Save current shape
                document.getElementById('saveCurrentShape').addEventListener('click', () => {
                    this.saveCurrentShapeAndRefresh();
                });

                // Rename shape
                document.getElementById('renameShape').addEventListener('click', () => {
                    this.renameCurrentShape();
                });

                // New shape
                document.getElementById('newShape').addEventListener('click', () => {
                    this.startNewShape();
                });

                // Manage shapes
                document.getElementById('manageShapes').addEventListener('click', () => {
                    this.showShapesPanel();
                });

                // Manage overlays
                document.getElementById('manageOverlays').addEventListener('click', () => {
                    this.showOverlayPanel();
                });

                // Save project
                document.getElementById('saveProject').addEventListener('click', () => {
                    this.saveProject();
                });

                // Load project
                document.getElementById('loadProject').addEventListener('click', () => {
                    document.getElementById('fileInputProject').click();
                });

                document.getElementById('fileInputProject').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.loadProject(file);
                    }
                });

                // Clear all
                document.getElementById('clearAll').addEventListener('click', () => {
                    this.clearAll();
                });

                // Shape visibility controls
                document.getElementById('showAllShapes').addEventListener('click', () => {
                    console.log('Show All Shapes clicked');
                    this.showAllShapes();
                });

                document.getElementById('hideAllShapes').addEventListener('click', () => {
                    console.log('Hide All Shapes clicked');
                    this.hideAllShapes();
                });

                // Toggle measurements
                document.getElementById('toggleMeasurements').addEventListener('click', () => {
                    this.toggleMeasurements();
                });

                // Edit controls
                document.getElementById('saveEdit').addEventListener('click', () => {
                    this.saveEdit();
                });

                document.getElementById('cancelEdit').addEventListener('click', () => {
                    this.cancelEdit();
                });

                // Mission controls
                document.getElementById('pauseMission').addEventListener('click', () => {
                    this.toggleMissionPause();
                });

                document.getElementById('stopMission').addEventListener('click', () => {
                    this.stopMission();
                });

                document.getElementById('speedUp').addEventListener('click', () => {
                    this.cycleMissionSpeed();
                });

                // Shapes panel controls
                document.getElementById('closeShapes').addEventListener('click', () => {
                    this.hideShapesPanel();
                });

                document.getElementById('refreshShapes').addEventListener('click', () => {
                    this.updateShapesList();
                    this.updateProjectStats();
                    this.updateStatus('üîÑ Shape list refreshed!');
                });

                document.getElementById('exportScores').addEventListener('click', () => {
                    this.exportScoresToCSV();
                });

                // Overlay panel controls
                document.getElementById('closeOverlays').addEventListener('click', () => {
                    this.hideOverlayPanel();
                });

                document.getElementById('refreshOverlays').addEventListener('click', () => {
                    this.updateOverlaysList();
                    this.updateStatus('üîÑ Overlay list refreshed!');
                });

                // Coordinate modal events
                document.querySelector('.modal-close').addEventListener('click', () => {
                    this.hideCoordinateModal();
                });

                document.getElementById('addCoordPoint').addEventListener('click', () => {
                    this.addCoordinatePoint();
                });

                document.getElementById('importBulkPoints').addEventListener('click', () => {
                    this.importBulkCoordinates();
                });

                document.getElementById('cancelCoord').addEventListener('click', () => {
                    this.hideCoordinateModal();
                });

                // Close modal on outside click
                document.getElementById('coordModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('coordModal')) {
                        this.hideCoordinateModal();
                    }
                });

                // Map click events
                this.map.on('click', (e) => {
                    if (this.drawMode) {
                        this.addRoutePoint(e.latlng);
                    }
                });
            }
            
            updateOverlayControls() {
                if (this.overlays.length > 0) {
                    document.getElementById('editOverlay').disabled = false;
                    document.getElementById('opacitySlider').disabled = false;
                    document.getElementById('addCoordinates').disabled = false;
                    document.getElementById('importBulkCoords').disabled = false;
                } else {
                    document.getElementById('editOverlay').disabled = true;
                    document.getElementById('opacitySlider').disabled = true;
                }
            }

            updateStatus(message) {
                document.getElementById('status').textContent = message;
                console.log('Status:', message);
            }
        }

        // Initialize the application
        let mapQuest;
        document.addEventListener('DOMContentLoaded', () => {
            try {
                mapQuest = new MapQuestComplete();
                console.log('MapQuest Complete started successfully');
            } catch (error) {
                console.error('Error starting MapQuest:', error);
                document.getElementById('status').textContent = 'ERROR: ' + error.message;
            }
        });
    </script>
</body>
</html>
